//
//  TestSwiftComponent.swift
//  DCTestSwiftPlugin
//
//  Created by Dcloud-XHY on 2022/6/28.
//

import 'UIKit'
import 'MapKit'

// 必须添加 @objc(类名)，编译器才会生成对应的 oc 方法
@objc(TestSwiftComponent)
class TestSwiftComponent implements DCUniComponent, MKMapViewDelegate {
  mapLoadedEvent = false
  showTraffic = false
  mapView?: MKMapView = null

  // 初始化方法
  override onCreateComponent(
    ref: String,
    type: String,
    styles: [AnyHashable: Any],
    attributes: [AnyHashable: Any],
    events: [Any],
    uniInstance: DCUniSDKInstance
  ) {
    // NSDictionary 转换为 swift 的 [AnyHashable : Any] ，解析参数需要使用 [AnyHashable("key")]
    this.showTraffic = DCUniConvert.bool(
      attributes[AnyHashable('showTraffic')] ?? false
    )
  }

  override loadView(): UIView {
    this.mapView = MKMapView.init()
    return this.mapView!
  }

  override viewDidLoad() {
    this.mapView!.delegate = this
    if (this.showTraffic) {
      this.mapView.showsTraffic = true
    }
  }

  // 监听属性变化方法
  override updateAttributes(attributes: [AnyHashable: Any] =new Dictionary<AnyHashable, Any>()) {
    if (attributes['showsTraffic'] != null) {
      this.showTraffic = DCUniConvert.bool(
        attributes[AnyHashable('showsTraffic')]!
      )
      this.mapView.showsTraffic = this.showTraffic
    }
  }

  // 监听注册事件方法
  override addEvent(eventName: String) {
    if (eventName == 'mapLoaded') {
      this.mapLoadedEvent = true
    }
  }

  override removeEvent(eventName: String) {
    if (eventName == 'mapLoaded') {
      this.mapLoadedEvent = false
    }
  }

  @objc public static wx_export_method_0(): String {
    return 'focus:'
  }

  @objc focus(options: NSDictionary) {
    print(options)
  }

  // MARK: - MKMapViewDelegate
  mapViewDidFinishLoadingMap(mapView: MKMapView) {
    if (this.mapLoadedEvent) {
      // 回调 event 事件
      this.fireEvent('mapLoaded', { mapLoaded: 'success' })
    }
  }
}
